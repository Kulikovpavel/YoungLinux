<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Защита файлов</title>
    <base href="" />
    <link type="text/css" rel="stylesheet" href="http://younglinux.info/misc/print.css" />
      </head>
  <body>
              <div class="section-1">
                <div class="section-2">
          
    <div id="node-204" class="section-3">
  <h1 class="book-heading">Защита файлов</h1>
  <h2>Права доступа: первая линия обороны Linux</h2>
<p>Модель безопасности Linux основана на той, которая используется в системах UNIX, и является такой же строгой (и иногда даже более). В системе Linux каждый файл принадлежит пользователю и группе пользователей. Есть также третья категория пользователей, которые не являются пользователем-владелецем и не принадлежат группе, владеющей файлом. Для каждой категории пользователей, разрешение на чтение, запись и выполнение может быть предоставлено или отклонено.</p>
<p>Мы уже использовали "длинный" вариант просмотра файлов с помощью команды <strong>ls </strong> <span class="mono"> -l</span>, хотя и по другим причинам. Эта команда также отображает разрешения файла (права доступа) для этих трех категорий пользователей; они указаны девятью символами, которые следуют за первым символом (индикатором типа файла). Как видно из приведенных ниже примеров, первые три символа из этой серии девяти отображают права доступа реального пользователя, который является владельцем файла. Следующие три — предназначены для группы-владельца файла, последние три — для других пользователей. Разрешения всегда описываются в одном и том же порядке: чтение, запись и исполнение (выполнение, запуск) для пользователя, группы и других. Вот некоторые примеры:</p>
<pre>
marise:~> <strong>ls -l To_Do</strong>
-rw-rw-r--    1 marise  users      5 Jan 15 12:39 To_Do
marise:~> <strong>ls -l /bin/ls</strong>
-rwxr-xr-x    1 root    root   45948 Aug  9 15:01 /bin/ls*
</pre><p>
Первый файл является обычным (вначале прочерк). Пользователь с именем <em>marise</em> или пользователи, принадлежащие к группе <em>users</em>, могут читать и переписывать (изменять/перемещать/удалять) файл, но они не могут исполнять его (второе и третье тире). Другим пользователям разрешено только читать этот файл, но они не могут изменять или выполнять его (четвертое и пятое тире).</p>
<p>Второй пример — это исполняемый файл; отличие: все могут запустить данную программу, но вам нужно быть суперпользователем, чтобы изменить его.</p>
<p>Info-страницы подробно объясняют, каким образом команда <strong>ls</strong> управляет отображением прав доступа (см. в разделе <em>What information is listed</em>).</p>
<p>Для удобства работы с командами, как права доступа (или режимы), так и категории пользователей имеют коды. См. таблицы ниже.</p>
<p><strong>Таблица 3.7. Коды режимов доступа</strong></p>
<table class="il">
<tr>
<td width="100"><strong>Код</strong></td>
<td><strong>Значение</strong></td>
</tr>
<tr>
<td>0 или -</td>
<td>Права доступа, которые должны были прописаны в данном месте, не предоставляются.</td>
</tr>
<tr>
<td>4 или r</td>
<td>Предоставляется право на чтение для определенной категории пользователей.</td>
</tr>
<tr>
<td>2 или w</td>
<td>Право на запись для категории пользователей, определенных в данном месте.</td>
</tr>
<tr>
<td>1 или x</td>
<td>Право на выполнение для определенной категории пользователей.</td>
</tr>
</table>
<p><strong>Таблица 3.8. Коды группы пользователей</strong></p>
<table class="il">
<tr>
<td width="100"><strong>Код</strong></td>
<td><strong>Значение</strong></td>
</tr>
<tr>
<td>u</td>
<td>Права пользователя</td>
</tr>
<tr>
<td>g</td>
<td>Права группы</td>
</tr>
<tr>
<td>o</td>
<td>Права для остальных</td>
</tr>
</table>
<p>Использование данного механизма разделения прав обязательно; это позволяет обеспечить высокий уровень безопасности даже без сетевой защиты. Среди прочих функций такая схема безопасности заботится о доступе пользователей к программам, <span style="background-color:yellow;">it can serve files on a need-to-know basis</span> и защищает конфиденциальные данные, такие как домашние каталоги и системные конфигурационные файлы.</p>
<p>Вы должны знать ваше имя пользователя. Если вы не знаете, то его можно отобразить, используя команду <strong>id</strong>, которая также отображает группу по умолчанию, к которой вы принадлежите и, в конечном итоге, другие группы, членом которых вы являетесь:</p>
<pre>
tilly:~> <strong>id</strong>
uid=504(tilly) gid=504(tilly) groups=504(tilly),100(users),2051(org)
Ваше имя пользователя, также хранится в переменной окружения USER:
tilly:~> <strong>echo $USER</strong>
tilly
</pre><h2>Инструменты</h2>
<h3>Команда chmod</h3>
<p>Обычным следствием применения строгих правил доступа к файлам, а иногда и неудобством, является то, что права доступа должны быть изменены по тем или иным причинам. Чтобы это сделать, мы используем команду <strong>chmod</strong>, что привело  к тому, что <em>chmod</em> стал почти приемлемым английским глаголом, обозначающим  изменение режима доступа к файлу. Команда <strong>chmod</strong> может быть использована с буквенными и числовыми опциями, что вам больше всего нравится.</p>
<p>В приведенном ниже примере используются буквенные параметры для решения  проблемы, с которой обычно сталкиваются начинающие пользователи:</p>
<pre>
asim:~> <strong>./hello</strong>
bash: ./hello: bad interpreter: Permission denied

asim:~> <strong>cat hello</strong>
#!/bin/bash
echo "Hello, World"

asim:~> <strong>ls -l hello</strong>
-rw-rw-r--    1 asim    asim    32 Jan 15 16:29 hello

asim:~> <strong>chmod u+x hello</strong>

asim:~> <strong>./hello</strong>
Hello, World

asim:~> <strong>ls -l hello</strong>
-rwxrw-r--   1 asim    asim    32 Jan 15 16:29 hello*
</pre><p>
+ и - используются для разрешения или запрещения конкретного права для определенной категории. Комбинации через запятую не допускаются. Info и man-страницы содержат полезные примеры. Здесь еще один, в котором файл из предыдущего примера становится личным файлом пользователя <em>asim</em>:</p>
<pre>
asim:~> <strong>chmod u+rwx,go-rwx hello</strong>

asim:~> <strong>ls -l hello</strong>
-rwx------    1 asim    asim    32 Jan 15 16:29 hello*
</pre><p>
Ситуации, в которых появляются сообщения об ошибках, говорящих, что допуск запрещен, как правило, связаны с проблемой прав доступа. Также, реплики вроде: "Это работало вчера" и "Когда я запускаю это как <em>root</em>, то оно работает", скорее всего, вызваны тем, что не были учтены права доступа к файлам.</p>
<p>При использовании <strong>chmod</strong> с цифровыми аргументами, значения для каждого предоставляемого права доступа указываются в "месторасположение" категории. Таким образом, получается трехзначное число, которое представляет собой символическое обозначение того, что должна сделать команда <strong>chmod</strong>. В следующей таблице перечислены наиболее распространенные комбинации.</p>
<p><strong>Таблица 3.9. Защита файлов с помощью chmod</strong></p>
<table class="il">
<tr>
<td width="200"><strong>Код</strong></td>
<td><strong>Значение</strong></td>
</tr>
<tr>
<td><strong>chmod </strong> <span class="mono"> 400 file</span></td>
<td>Защита файла от случайной перезаписи</td>
</tr>
<tr>
<td><strong>chmod </strong> <span class="mono"> 500 directory</span></td>
<td>Чтобы защитить себя от случайного удаления, переименования или перемещения файлов из этой директории.</td>
</tr>
<tr>
<td><strong>chmod </strong> <span class="mono"> 600 file</span></td>
<td>Личный файл, изменяемый только пользователем, который ввел эту команду.</td>
</tr>
<tr>
<td><strong>chmod </strong> <span class="mono"> 644 file</span></td>
<td>Всеми читаемый файл, который может быть изменен только  пользователем-владельцем.</td>
</tr>
<tr>
<td><strong>chmod </strong> <span class="mono"> 660 file</span></td>
<td>Пользователи, принадлежащие вашей группе, могут изменить этот файл, другие не имеют никакого отношения к нему вообще.</td>
</tr>
<tr>
<td><strong>chmod </strong> <span class="mono"> 700 file</span></td>
<td>Защищает файл от любого доступа посторонних, в то же время пользователь-владелец имеет полный контроль.</td>
</tr>
<tr>
<td><strong>chmod </strong> <span class="mono"> 755 directory</span></td>
<td>Для файлов, которые должны быть читаемыми и исполняемыми всеми, но изменяемые только пользователем-владельцем.</td>
</tr>
<tr>
<td><strong>chmod </strong> <span class="mono"> 775 file</span></td>
<td>Стандартный режим совместного использования файла  группой.</td>
</tr>
<tr>
<td><strong>chmod </strong> <span class="mono"> 777 file</span></td>
<td>Каждый может делать с этим файлом все, что хочет.</td>
</tr>
</table>
<p>Если в качестве аргумента <strong>chmod</strong> вы вводите число, состоящее менее чем из трех цифр, опущенные символы заменяются на нули, начиная слева. В системах Linux на самом деле существует четвертая цифра, которая предшествует первому из трех и устанавливает специальные режимы доступа. Все об этом и многом другом находится в info-страницах.</p>
<h3>Вступление в другую группу</h3>
<p>Когда вы введете <strong>id</strong> в командной строке, то получите список всех групп, к которым  вы можете принадлежать; перед этим будет ваше имя пользователя и ID, а также название группы и ее ID, с которой вы в настоящее время связаны. Однако, во многих системах Linux можно активно входить только в одну группу в одно и то же время. По умолчанию, это активная или первичная группа является первой, которая вам устанавливается из файла <span class="mono">/etc/passwd</span>. Четвертое поле в этом файле содержит ID основной группы пользователей, что можно также увидеть в файле <span class="mono">/etc/group</span>. Например:</p>
<pre>
asim:~> <strong>id</strong>
uid=501(asim) gid=501(asim) groups=100(users),501(asim),3400(web)

asim:~> <strong>grep asim /etc/passwd</strong>
asim:x:501:501:Asim El Baraka:/home/asim:/bin/bash

asim:~> <strong>grep 501 /etc/group</strong>
asim:x:501:
</pre><p>
В приведенном выше примере четвертое поле в строке из <span class="mono">/etc/passwd</span> содержит значение "501", которое представляет собой группу asim. Из <span class="mono">/etc/group</span> мы можем получить имя, соответствующие этому идентификатору группы. При первом подключении к системе, это та группа, к которой будет принадлежать <em>asim</em>.</p>
<p class="note"><img src="../../../img/linuxintro/note.gif" alt="" /><strong>"Механизм" индивидуальной группы пользователя. </strong><br />
В целях обеспечения большей гибкости, большинство систем Linux преследуют так называемую индивидуальную групповую схему пользователей, которая, в первую очередь, присваивает каждому пользователю его собственную группу. Этой группе принадлежит только данный пользователь, отсюда и название "личная группа". Обычно эта группа имеет такое же имя как название логина пользователя, что может приводить к небольшой путанице.</p>
<p>Помимо своей собственной группы, пользователь <em>asim</em> также может быть в группах <em>users</em> и <em>web</em>. Т.к. это вторые группы для данного пользователя, ему придется использовать команду <strong>newgrp</strong>, чтобы войти в любую из этих групп (сначала используйте <strong>gpasswd</strong> для установки пароля для группы). В этом примере asim необходимо создать файлы, которые принадлежат группе <em>web</em>.</p>
<pre>
asim:/var/www/html> <strong>newgrp web</strong>

asim:/var/www/html> <strong>id</strong>
uid=501(asim) gid=3400(web) groups=100(users),501(asim),3400(web)
</pre><p>
Теперь, когда <em>asim</em> создает новые файлы, они будут находиться в собственности группы <em>web</em>, вместо того, чтобы принадлежать группе <em>asim</em>:</p>
<pre>
asim:/var/www/html> <strong>touch test</strong>

asim:/var/www/html> <strong>ls -l test</strong>
-rw-rw-r--  1 asim web   0 Jun 10 15:38 test
</pre><p>
Вход в новую группу освобождает вас от необходимости использовать chown (см. <a href="http://younglinux.info/#">Раздел "Смена владельцев и групп"</a>) или вызывать системного администратора для смены владельцев для вас.</p>
<p>См. man-страницу для <strong>newgrp</strong> для получения дополнительной информации.</p>
<h3>Маска файла</h3>
<p>Прежде чем новый файл куда-то сохраняется, он подвергаться стандартной процедуре защиты. В Linux не существуют файлы без установленных прав доступа. Стандартное разрешение на файл определяется маской при его создании. Значение этой маски может быть получено с помощью команды <strong>umask</strong>:</p>
<pre>
bert:~> umask
0002
</pre><p>
Вместо добавления символических значений друг к другу, как с <strong>chmod</strong>, для выяснения разрешения на новый файл, необходимо вычесть из суммарной возможности прав доступа. Однако в примере выше мы видим четыре значения, но есть только три категории разрешений: для пользователя, группы и других. Первый ноль — это установленные специальные файловые атрибуты, которые мы будем обсуждать в <a href="http://younglinux.info/#">Разделе "Смена владельцев и групп"</a> и в <a href="http://younglinux.info/#">Разделе "SUID и SGID"</a>. Возможно, с тем же успехом, в вашей системе этот первый ноль не отображается при вводе команды <strong>umask</strong>, и тогда вы видите только три числа, представляющих маску по умолчанию, «накладываемую» на файл.</p>
<p>Каждая UNIX-подобная система имеет системную функцию для создания новых файлов, которая вызывается каждый раз, когда пользователь использует программу, которая создает новые файлы, например, при загрузке файлов из Интернета, при сохранении нового текстового документа и т.д. Эта функция создает как новые файлы, так и директории. Полные права на чтение, запись и выполнение предоставляются всем при создании нового каталога. При создании нового файла, эта функция создаст право на чтение и запись для всех, но прав на выполнение отсутствует для всех категорий пользователей. Таким образом, первоначально применяется маска для каталога с разрешением <em>777</em> или <em>rwxrwxrwx</em>, а для обычного файла <em>666</em> или <em>rw-rw-rw-</em>.</p>
<p>Значение <strong>umask</strong> вычитается из этих разрешений по умолчанию, определенных инструментом, создающим новый файл или каталог. Таким образом, каталог будет иметь права доступа <em>775</em> по умолчанию, а файл <em>664</em>, если значение маски <em>(0)002</em>. Это демонстрируется на примере ниже:</p>
<pre>
bert:~> <strong>mkdir newdir</strong>

bert:~> <strong>ls -ld newdir</strong>
drwxrwxr-x    2 bert    bert		4096 Feb 28 13:45 newdir/

bert:~> <strong>touch newfile</strong>

bert:~> <strong>ls -l newfile</strong>
-rw-rw-r--    1 bert    bert		   0 Feb 28 13:52 newfile
</pre><p class="note"><img src="../../../img/linuxintro/note.gif" alt="" /><strong> Файлы по сравнению с каталогами. </strong><br />
Каталог получает больше разрешений по умолчанию: он всегда имеет разрешение на выполнение. Если бы не это, они не были бы доступны. Исследуйте это, изменив режим доступа к каталогу на 644!</p>
<p>Если вы войдете в другую группу, используя команду <strong>newgrp</strong>, маска остается неизменной. Таким образом, если она установлена на <em>002</em>, файлы и каталоги, которые вы создаете, находясь в новой группе, также будут доступны для других членов этой группы; вам не придется использовать команду <strong>chmod</strong>.</p>
<p>Пользователь <em>root</em> обычно имеет более строгую маску по умолчанию:</p>
<pre>
[root@estoban root]# <strong>umask</strong>
022
</pre><p>
Эти значения по умолчанию — общесистемная установка в конфигурационном файле shell, например <span class="mono">/etc/bashrc</span> или <span class="mono">/etc/profile</span>. Вы можете изменить их на ваш собственный файл конфигурации shell, см. в <a href="http://younglinux.info/#">Главе 7, “Дом сладкий /home”</a> о настройках окружения оболочки.</p>
<h3>Смена владельцев и групп</h3>
<p>Если файл находится в собственности не того пользователя или группы, то недочет может быть устранен с помощью команд <strong>chown</strong> (смена владельца) и <strong>chgrp</strong> (смена группы). В среде, где файлы должны находиться в коллективном доступе группы, изменение владельца является частой задачей системного администрирования. Обе команды достаточно гибкие, о чем можно узнать с помощью опции <span class="mono">--help</span>.</p>
<p>Команда <strong>chown</strong> может использоваться как для изменения владельца-пользователя файла, так и группы, а <strong>chgrp</strong> изменяет только группу. Конечно, система проверит, имеет ли пользователь, использующий эти команды, достаточно прав на файл(ы), чтобы изменять владельцев.</p>
<p>Чтобы изменить лишь владельца-пользователя файла, используйте следующий синтаксис:</p>
<p><span class="mono">chown <em>newuser</em> file</span> </p>
<p>Если вы используете двоеточие после имени пользователя (см. info-страницы), группа-владелец будет изменена также на основную группу пользователя, запускающего команду. В системе Linux каждый пользователь имеет свою собственную группу, так что эта особенность может использоваться, чтобы делать файлы личными:</p>
<pre>
jacky:~> <strong>id</strong>
uid=1304(jacky) gid=(1304) groups=1304(jacky),2034(pproject)

jacky:~> <strong>ls -l my_report</strong>
-rw-rw-r--  1 jacky   project       29387 Jan 15 09:34 my_report

jacky:~> <strong>chown jacky: my_report</strong>

jacky:~> <strong>chmod o-r my_report</strong>

jacky:~> <strong>ls -l my_report</strong>
-rw-rw----  1 jacky   jacky         29387 Jan 15 09:34 my_report
</pre><p>
Если <em>jacky</em> захотел бы поделиться этим файлом, без предоставления всем разрешения на запись, то он может использовать команду <strong>chgrp</strong>:</p>
<pre>
jacky:~> <strong>ls -l report-20020115.xls</strong>
-rw-rw---- 1 jacky   jacky   45635 Jan 15 09:35 report-20020115.xls

jacky:~> <strong>chgrp project report-20020115.xls</strong>

jacky:~> <strong>chmod o= report-20020115.xls</strong>

jacky:~> <strong>ls -l report-20020115.xls</strong>
-rw-rw---- 1 jacky   project 45635 Jan 15 09:35 report-20020115.xls
</pre><p>
Таким образом, пользователи из группы <em>project</em> смогут работать с этим файлом. У пользователей не из этой группы нет никакого доступа к нему вообще.</p>
<p>Как <strong>chown</strong>, так и <strong>chgrp</strong> могут быть использованы для рекурсивной смены владельца с помощью опции <span class="mono">-r</span>. В этом случае, все вложенные файлы и подкаталоги данного каталога будет принадлежать указанному пользователю и/или группе.</p>
<p class="note"><img src="../../../img/linuxintro/note.gif" alt="" /><strong> Ограничения.</strong><br />
На большинстве систем, использование команд <strong>chown</strong> и <strong>chgrp</strong> ограничено для непривилегированных пользователей. Если вы не администратор системы, то не можете изменить пользователя или группу по соображениям безопасности. Если использование этих команд не будет ограничено, то злостные пользователи могут назначать владельцами файлов других пользователей и/или другие группы, и изменить поведение окружения пользователей, и даже повредить чужие для них файлы.</p>
<h3>Специальные режимы</h3>
<p>Чтобы все время не беспокоить системного администратора решением проблем, связанных с правами, специальные права доступа могут быть предоставлены для целых каталогов или отдельных программ. Есть три специальных режима:</p>
<ul>
<li>Режим "липкого бита": После выполнения задания, команда находится в оперативной памяти. Первоначально это была функция, которая использовалась в основном для сохранения памяти: большие рабочие части загружались в память только один раз. Но в наши дни память не такая дорогая и есть технологии, которые управляют ей лучше, поэтому это больше не используются для оптимизации возможностей на отдельных файлах. По отношению к целому каталогу, однако, у липкого бита есть другое значение. В этом случае, пользователь может изменять файлы в данной директории, если является владелец файла или файл имеет соответствующие разрешения. Эта возможность используется для таких каталогов как <span class="mono">/var/tmp</span>, которые должны быть доступны для всех, но где нельзя пользователям изменять или удалять данные друг друга. Липкий бит указывает в конце поля прав доступа к файлу:</li>
</ul>
<pre>
mark:~> <strong>ls -ld /var/tmp</strong>
drwxrwxrwt   19 root     root         8192 Jan 16 10:37 /var/tmp/
</pre><p>
Липкий бит установливается с помощью команды <strong>chmod </strong> <span class="mono"> o+t <em>directory</em></span>. Историческое происхождение “t” - сохранение возможности <em>Text access</em> (текстовый доступ) в UNIX.</p>
<ul>
<li>SUID (установка ID пользователя) и SGID (установка ID группы): представлены символом s в поле прав доступа пользователя или группы. Когда этот режим установлен на исполняемый файл, то он будет запускаться с правами пользователя и группы, имеющих разрешения на файл, а не под тем пользователем, который ввел команду, таким образом, предоставляется доступ к системным ресурсам. Мы обсудим это далее в <a href="http://younglinux.info/#">Главе 4, Процессы</a>.</li>
<li>SGID (установка ID группы) на каталог: в этом конкретном случае все файлы, созданные в данном каталоге, будут иметь туже группу-владельца, что и сам каталог (в то время как нормальным поведением является то, что новые файлы принадлежат пользователям, которые их создают). Таким образом, пользователям не нужно беспокоиться о собственности файла при совместном использовании папок:</li>
</ul>
<pre>
mimi:~> <strong>ls -ld /opt/docs</strong>
drwxrws---  4 root    users          4096 Jul 25 2001 docs/

mimi:~> <strong>ls -l /opt/docs</strong>
-rw-rw----  1 mimi    users        345672 Aug 30 2001-Council.doc
</pre><p>
Это стандартный способ совместного доступа к файлам в UNIX.</p>
<p class="note"><img src="../../../img/linuxintro/note.gif" alt="" /><strong>  Имеющиеся файлы остаются без изменений!</strong><br />
Файлы, которые перемещаются в SGID-каталог, но были созданы в других местах, сохраняют их первоначальные пользователя-владельца и группу. Это может привести к путанице.</p>
  </div>
    </div></div>
  </body>
</html>
